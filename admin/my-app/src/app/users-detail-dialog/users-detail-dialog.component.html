<mat-dialog-content>
  <div class="p-4">
    <div class="flex justify-between items-center mb-4">
      <h2 mat-dialog-title>{{ isNewUser ? 'Create a user' : 'User Details' }}
        <span *ngIf="!isNewUser"> #{{userDetail.id}}</span>
      </h2>
      <button 
        *ngIf="!isNewUser && !isEditMode" 
        mat-icon-button 
        color="primary" 
        (click)="editUser()"
        matTooltip="Edit user"
      >
        <mat-icon>edit</mat-icon>
      </button>
    </div>

    <!-- 基础信息卡片 -->
    <mat-card class="mb-6 shadow-md">
      <mat-card-header class="bg-primary/10 px-4 py-3">
        <mat-card-title class="text-lg font-medium">User basic information</mat-card-title>
      </mat-card-header>
      <br>
      <mat-card-content class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- 用户名（禁用） -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">User name</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ userDetail.username }}
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <input matInput formControlName="username" [disabled]="true">
              </mat-form-field>
            </div>
          </div>

          <!-- 密码（禁用） -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                ******
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <input matInput type="password" formControlName="password" [disabled]="true">
                <mat-hint>The password cannot be modified.</mat-hint>
              </mat-form-field>
            </div>
          </div>

          <!-- Phone -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ userDetail.phone || '-' }}
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <input matInput formControlName="phone">
              </mat-form-field>
            </div>
          </div>

          <!-- Email -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ userDetail.email || '-' }}
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <input matInput formControlName="email" [pattern]="emailPattern">
                <mat-error *ngIf="userForm.get('email')?.hasError('email')">
                  Please enter a valid email address
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- Role -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ formatRole(userDetail.role) }}
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <mat-select formControlName="role" required>
                  <mat-option [value]="role" *ngFor="let role of ['user', 'admin', 'super_admin']">
                    {{ formatRole(role) }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- Avatar Number -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Avatar Number</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ userDetail.avatar_number || 0 }}
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <input matInput type="number" formControlName="avatar_number">
              </mat-form-field>
            </div>
          </div>

          <!-- Balance -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Balance</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ userDetail.balance }} CNY
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <input matInput type="number" formControlName="balance" min="0">
                <span matTextSuffix>CNY</span>
              </mat-form-field>
            </div>
          </div>
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Created At</label>
            <div class="flex">
              <div class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ formatDate(userDetail.created_at) }}
              </div>
            </div>
          </div>
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Updated At</label>
            <div class="flex">
              <div class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ formatDate(userDetail.updated_at) }}
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Related Data Cards -->
    <div class="grid grid-cols-1 md:grid-cols-1 gap-6 mb-6">
      <!-- Vehicles -->
      <mat-card class="shadow-md">
        <mat-card-header class="bg-primary/10 px-4 py-3">
          <mat-card-title class="text-lg font-medium">Vehicles ({{ vehicles.length }})</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-4">
          <div *ngIf="vehicles.length === 0" class="text-center py-6 text-gray-500">
            No vehicles found
          </div>
          <div *ngFor="let vehicle of vehicles; let last = last" class="mb-6 p-4 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow">
    <div class="space-y-2 flex justify-between items-center">
      <div>
        <span class="font-medium">License Plate:</span> {{ vehicle.license_plate }}
      </div>
          <button 
              *ngIf="!isNewUser" 
              mat-icon-button 
              color="warn" 
              (click)="deleteVehicle(vehicle.id)"
              matTooltip="Delete the vehicle"
            >
              <mat-icon>delete</mat-icon>
            </button>
            </div>
          <div class="space-y-2">
      <div><span class="font-medium">Type:</span> {{ vehicle.type }}</div>
      <div><span class="font-medium">Created At:</span> {{ formatDate(vehicle.created_at) }}</div>
      <div><span class="font-medium">Updated At:</span> {{ formatDate(vehicle.updated_at) }}</div>
    </div>
    <div *ngIf="!last" class="mt-6 h-px bg-gray-200"></div>
  </div>
</mat-card-content>

      <!-- Comments -->
      <mat-card class="shadow-md">
        <mat-card-header class="bg-primary/10 px-4 py-3">
          <mat-card-title class="text-lg font-medium">Comments ({{ comments.length }})</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-4">
          <div *ngIf="comments.length === 0" class="text-center py-6 text-gray-500">
            No comments found
          </div>
          <div *ngFor="let comment of comments; let last = last" class="mb-6 p-4 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow">
            <div class="space-y-2">
              <br>
              <div><span class="font-medium">Comment ID:</span>   {{ comment.comment_id }}</div>
              <button 
              *ngIf="!isNewUser" 
              mat-icon-button 
              color="warn" 
              (click)="deleteComment(comment.comment_id)"
              matTooltip="Delete the comment"
            >
              <mat-icon>delete</mat-icon>
            </button>
              <div><span class="font-medium">Rating:</span>   {{ comment.rating }}</div>
              <div><span class="font-medium">Comment:</span>   {{ comment.comment || 'No comment' }}</div>
              <div><span class="font-medium">Order ID:</span>   {{ comment.order_id }}</div>
              <div><span class="font-medium">Parking ID:</span>   {{ comment.parking_space_id }}</div>
              <div><span class="font-medium">Vehicle Plate:</span>   {{ comment.vehicle_plate || 'The vehicle has been deleted'}}</div>
              <div><span class="font-medium">Created At:</span>   {{ formatDate(comment.created_at) }}</div>
            </div>
            <div *ngIf="!last" class="mt-6 h-px bg-gray-200"></div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Bookings -->
      <mat-card class="shadow-md">
        <mat-card-header class="bg-primary/10 px-4 py-3">
          <mat-card-title class="text-lg font-medium">Bookings ({{ bookings.length }})</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-4">
          <div *ngIf="bookings.length === 0" class="text-center py-6 text-gray-500">
            No bookings found
          </div>
          <div *ngFor="let booking of bookings; let last = last" class="mb-6 p-4 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow">
              <div class="space-y-2 flex justify-between items-center">
                <div>
                  <span class="font-medium">Order ID:</span> {{ booking.id || 'N/A' }}
                </div>
                <button 
                  *ngIf="!isNewUser" 
                  mat-icon-button 
                  color="warn" 
                  (click)="deleteBooking(booking.id)"
                  matTooltip="Delete the reservation"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <div><span class="font-medium">Parking Space ID:</span>   {{ booking.parking_space_id }}</div>
              <div><span class="font-medium">License Plate:</span>   {{ booking.license_plate || 'The vehicle has been deleted'}}</div>
              <div><span class="font-medium">Status:</span>   {{ formatStatus(booking.status) }}</div>
              <div><span class="font-medium">Space Type:</span>   {{ formatStatus(booking.space_type) }}</div>
              <div><span class="font-medium">Charging Rate:</span>   {{ booking.charging_rate }} CNY/kWh</div>
              <div><span class="font-medium">Parking Rate:</span>   {{ booking.parking_rate }} CNY/hour</div>
              <div><span class="font-medium">Overtime Occupancy Rate:</span>   {{ booking.overtime_occupancy_rate }} CNY/min</div>
              <div><span class="font-medium">Start Time:</span>   {{ formatDate(booking.start_time) }}</div>
              <div><span class="font-medium">End Time:</span>   {{ formatDate(booking.end_time) }}</div>
              <div><span class="font-medium">Created At:</span>   {{ formatDate(booking.created_at) }}</div>
            </div>
            <div *ngIf="!last" class="mt-6 h-px bg-gray-200"></div>

    
      <!-- Usage Records -->
      <div *ngFor="let record of usageRecords; let last = last" class="mb-6 p-4 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow">
          <div class="space-y-2 flex justify-between items-center">
            <div>
              <span class="font-medium">Record ID:</span> {{ record.id }}
            </div>
              <button 
                *ngIf="!isNewUser" 
                mat-icon-button 
                color="warn" 
                (click)="deleteUsageRecord(record.id)"
                matTooltip="Delete the usage record"
                >
                <mat-icon>delete</mat-icon>
              </button>
              </div>
              <div><span class="font-medium">Parking Space ID:</span>   {{ record.parking_space_id }}</div>
              <div><span class="font-medium">License Plate:</span>   {{ record.license_plate || 'The vehicle has been deleted'}}</div>
              <div><span class="font-medium">Status:</span>   {{ formatStatus(record.status) }}</div>
              <div><span class="font-medium">Total Fee:</span>   {{ record.total_fee }} CNY</div>
              <div><span class="font-medium">Electricity Used:</span>   {{ record.electricity_used ? formatStatus(record.electricity_used) : '0'}} kWh</div>
              <div><span class="font-medium">Parking Minutes:</span>   {{ record.parking_minutes }}</div>
              <div><span class="font-medium">Overtime Minutes:</span>   {{ record.overtime_minutes }}</div>
              <div><span class="font-medium">Space Type:</span>   {{ formatStatus(record.space_type) }}</div>
              <div><span class="font-medium">Charging Rate:</span>   {{ record.charging_rate }} CNY/kWh</div>
              <div><span class="font-medium">Parking Rate:</span>   {{ record.parking_rate }} CNY/hour</div>
              <div><span class="font-medium">Overtime Occupancy Rate:</span>   {{ record.overtime_occupancy_rate }} CNY/min</div>
              <div><span class="font-medium">Start Time:</span>   {{ formatDate(record.start_time) }}</div>
              <div><span class="font-medium">End Time:</span>   {{ record.end_time ? formatDate(record.end_time) : '-' }}</div>
              <div><span class="font-medium">Charging Start Time:</span>   {{ record.charging_start_time ? formatDate(record.charging_start_time) : '-' }}</div>
              <div><span class="font-medium">Charging Complete Time:</span>   {{ record.charging_complete_time ? formatDate(record.charging_complete_time) : '-' }}</div>
              <div><span class="font-medium">Created At:</span>   {{ formatDate(record.created_at) }}</div>
              <div><span class="font-medium">Updated At:</span>   {{ formatDate(record.updated_at) }}</div>
            </div>
            <div *ngIf="!last" class="mt-6 h-px bg-gray-200"></div>



<mat-dialog-actions class="px-6 py-4 justify-end">
  <button 
    mat-stroked-button 
    color="primary" 
    (click)="cancel()"
    [disabled]="loading"
  >
    Cancel
  </button>
  <button 
    *ngIf="isEditMode"
    mat-flat-button 
    color="primary" 
    [disabled]="loading || userForm.invalid" 
    (click)="saveUser()"
    class="ml-3"
  >
    {{ isNewUser ? 'Create User' : 'Save Changes' }}
    <mat-spinner *ngIf="loading" diameter="20" class="ml-2"></mat-spinner>
  </button>
</mat-dialog-actions>