<mat-dialog-content>
  <div class="p-4">
    <div class="flex justify-between items-center mb-4">
      <h2 mat-dialog-title>
        {{ isNewSpace ? '新建车位' : '车位详情 #' + parkingDetail.id }}
      </h2>
      <button 
        *ngIf="!isNewSpace && !isEditMode" 
        mat-icon-button 
        color="primary" 
        (click)="editSpace()"
        matTooltip="编辑车位"
      >
        <mat-icon>edit</mat-icon>
      </button>
    </div>

    <!-- 基础信息卡片 -->
    <mat-card class="mb-6 shadow-md">
      <mat-card-header class="bg-primary/10 px-4 py-3">
        <mat-card-title class="text-lg font-medium">车位基础信息</mat-card-title>
      </mat-card-header>
      <mat-card-content class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- 车位ID -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">车位ID</label>
            <div class="bg-gray-50 p-2 rounded border border-gray-200">
              {{ parkingDetail.id || '新建中' }}
            </div>
          </div>

          <!-- 车位类型 -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">车位类型</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ getTypeDisplay(parkingDetail.typeDetail.type) }}
                <div class="text-sm text-gray-500 mt-1">
                  充电功率：{{ parkingDetail.typeDetail.power }}kW | 停车费：{{ parkingDetail.typeDetail.parking_rate }}元/小时
                </div>
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <mat-select 
                  formControlName="type_id" 
                  required
                  placeholder="选择车位类型"
                >
                  <mat-option 
                    *ngFor="let type of parkingSpaceTypes" 
                    [value]="type.id"
                  >
                    {{ getTypeDisplay(type.type) }} - {{ type.power }}kW
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- 当前状态 -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">当前状态</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ getStatusDisplay(parkingDetail.status) }}
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <mat-select formControlName="status" required>
                  <mat-option 
                    [value]="status" 
                    *ngFor="let status of ['idle', 'occupied', 'booked']"
                  >
                    {{ getStatusDisplay(status) }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- 占用车辆 -->
          <div class="form-field-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">占用车辆</label>
            <div class="flex">
              <div *ngIf="!isEditMode" class="bg-gray-50 p-2 rounded border border-gray-200 w-full">
                {{ parkingDetail.currentVehicle?.license_plate || '-' }}
                <div class="text-sm text-gray-500 mt-1" *ngIf="parkingDetail.currentVehicle">
                    车主：{{ parkingDetail.currentVehicle.userInfo_name || '-' }} | 
                    电话：{{ parkingDetail.currentVehicle.userInfo_phone || '-' }}
                </div>
              </div>
              <mat-form-field *ngIf="isEditMode" class="w-full">
                <input 
                  matInput 
                  formControlName="vehicle_id" 
                  placeholder="输入车辆ID（可选）"
                  [disabled]="parkingDetail.status === 'idle'"
                >
                <mat-hint>仅当状态为占用或预约时填写</mat-hint>
              </mat-form-field>
            </div>
          </div>

          <!-- 时间信息 -->
          <div class="col-span-2">
            <div class="grid grid-cols-2 gap-4">
              <!-- 创建时间 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">创建时间</label>
                <div class="bg-gray-50 p-2 rounded border border-gray-200">
                  {{ formatDate(parkingDetail.created_at) }}
                </div>
              </div>
              
              <!-- 更新时间 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">更新时间</label>
                <div class="bg-gray-50 p-2 rounded border border-gray-200">
                  {{ formatDate(parkingDetail.updated_at) }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- 关联数据卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- 使用记录 -->
      <mat-card class="shadow-md">
        <mat-card-header class="bg-primary/10 px-4 py-3">
          <mat-card-title class="text-lg font-medium">
            使用记录 ({{ parkingDetail.usageRecords.length }})
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-4">
          <div *ngIf="parkingDetail.usageRecords?.length === 0" class="text-center py-6 text-gray-500">
  暂无使用记录
</div>
          <div *ngFor="let record of parkingDetail.usageRecords || []"
            class="mb-3 p-3 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow"
          >
            <div class="flex justify-between">
              <span class="font-medium">开始时间:</span>
              <span>{{ formatDate(record.start_time) }}</span>
            </div>
            <div class="flex justify-between mt-1">
              <span class="font-medium">状态:</span>
              <span>{{ record.status }}</span>
            </div>
            <div class="flex justify-between mt-1">
              <span class="font-medium">用电量:</span>
              <span>{{ record.electricity_used || 0 }} 度</span>
            </div>
            <div class="flex justify-between mt-1">
              <span class="font-medium">总费用:</span>
              <span>{{ record.total_fee || 0 | currency:'CNY' }}</span>
            </div>
          </div>
          <div *ngIf="parkingDetail.usageRecords.length > 3" class="text-center text-primary cursor-pointer">
            查看更多 ({{ parkingDetail.usageRecords.length - 3 }}条)
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 预订记录 -->
      <mat-card class="shadow-md">
        <mat-card-header class="bg-primary/10 px-4 py-3">
          <mat-card-title class="text-lg font-medium">
            预订记录 ({{ parkingDetail.bookings.length }})
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-4">
          <div *ngIf="parkingDetail.bookings?.length === 0" class="text-center py-6 text-gray-500">
            暂无预订记录
        </div>
          <div *ngFor="let booking of parkingDetail.bookings || []" 
            class="mb-3 p-3 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow"
          >
            <div class="flex justify-between">
              <span class="font-medium">预订时间:</span>
              <span>{{ formatDate(booking.created_at) }}</span>
            </div>
            <div class="flex justify-between mt-1">
              <span class="font-medium">时间范围:</span>
              <span>
                {{ formatDate(booking.start_time) }} - {{ formatDate(booking.end_time) }}
              </span>
            </div>
            <div class="flex justify-between mt-1">
              <span class="font-medium">状态:</span>
              <span>{{ booking.status }}</span>
            </div>
          </div>
          <div *ngIf="parkingDetail.bookings.length > 3" class="text-center text-primary cursor-pointer">
            查看更多 ({{ parkingDetail.bookings.length - 3 }}条)
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions class="px-6 py-4 justify-end">
  <button 
    mat-stroked-button 
    color="primary" 
    (click)="cancel()"
    [disabled]="loading"
  >
    取消
  </button>
  <button 
    *ngIf="isEditMode"
    mat-flat-button 
    color="primary" 
    [disabled]="loading || parkingForm.invalid" 
    (click)="saveSpace()"
    class="ml-3"
  >
    {{ isNewSpace ? '创建车位' : '保存修改' }}
    <mat-spinner *ngIf="loading" diameter="20" class="ml-2"></mat-spinner>
  </button>
</mat-dialog-actions>