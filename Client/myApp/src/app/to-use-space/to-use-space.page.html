<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/tab1"></ion-back-button>
    </ion-buttons>
    <ion-title>Parking Space</ion-title>
  </ion-toolbar>
</ion-header>




<ion-content>
  <div *ngIf="isLoading">
    <ion-spinner></ion-spinner>
    <p>Loading parking spaces...</p>
  </div>
  <div *ngIf="!isLoading">
    <ion-card>
      <ion-card-header>
        <ion-card-title>{{ space.space_type }}</ion-card-title>
        <ion-card-subtitle>Status: {{ space.status }}</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>Rate:</ion-label>
            <ion-text>¥{{ space.charging_rate }}/kWh</ion-text>
          </ion-item>
          
          <ion-item>
            <ion-label>Parking Rate:</ion-label>
            <ion-text>¥{{ space.parking_rate }}/hour</ion-text>
          </ion-item>

          <ion-item *ngIf="space.overtime_occupancy_rate">
            <ion-label>Overtime Rate:</ion-label>
            <ion-text>¥{{ space.overtime_occupancy_rate }}/min</ion-text>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-list *ngIf="hasVehicle">
    <ion-card *ngFor="let Vehicle of currentVehicles " (click)="getCarID(Vehicle.id)" [class.selected-card]="selectedCarId === Vehicle.id">
      <ion-card-header>
        <ion-card-title>Your Vehicle</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label>License Plate:</ion-label>
          <ion-text>{{ Vehicle.license_plate }}</ion-text>
        </ion-item>
        <ion-item>
          <ion-label>Type:</ion-label>
          <ion-text>{{ Vehicle.type }}</ion-text>
        </ion-item>
      </ion-card-content>
    </ion-card>
  </ion-list>


      <ion-button 
      *ngIf="space.status === 'idle'"
      expand="block" 
      [disabled]="!hasVehicle"
      (click)="openBookingModal()">
      Book Now
    </ion-button>
    
    <ion-button 
      *ngIf="space.status === 'booked'"
      expand="block"
      [disabled]="!isMyCar"
      (click)="isMyCar && cancelBook()">
      {{ isMyCar ? 'Cancel Booking' : 'Booked By Others' }}
    </ion-button>
    
    <ion-button 
      *ngIf="space.status === 'idle' || hasVehicle"
      expand="block"
      (click)="openUsageModal()">
      Start Usage
    </ion-button>

    <ion-button 
      *ngIf="space.status === 'occupied'"
      expand="block"
      [disabled]="!isMyCar"
      (click)="isMyCar && openUpDateModal()">
      End Usage
    </ion-button>
    

    <ion-modal [isOpen]="isBookingModalOpen" (ionModalDidDismiss)="closeModal()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Confirm Booking</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeModal()">Close</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <p>Confirm booking for space {{ spaceId }} using vehicle {{ selectedCarId }}?</p>

          <ion-item>
            <ion-label position="stacked">Duration (0-60 minutes)</ion-label>
            <ion-range 
              [(ngModel)]="duration" 
              min="0" 
              max="60" 
              step="1"
              (ionChange)="updateEndTime()">
              <ion-label slot="start">0</ion-label>
              <ion-label slot="end">60</ion-label>
            </ion-range>
            <ion-note slot="end">{{ duration }} mins</ion-note>
          </ion-item>
    
          <ion-item>
            <ion-label>End Time:</ion-label>
            <ion-text color="primary">
              {{ endTime | date: 'yyyy-MM-dd HH:mm' }}
            </ion-text>
          </ion-item>
    
          <ion-button expand="block" (click)="confirmBooking()" [disabled]="!startTime">
            Confirm
          </ion-button>
        </ion-content>
      </ng-template>
    </ion-modal>

    <ion-modal [isOpen]="isUsageModalOpen" (ionModalDidDismiss)="closeModalTwo()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Confirm Usage</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeModalTwo()">Close</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <p>Confirm using space {{ spaceId }}?</p>
          <ion-button expand="block" (click)="confirmModalTwo()">Confirm</ion-button>
        </ion-content>
      </ng-template>
    </ion-modal>

    <ion-modal [isOpen]="isUpDateModalOpen" (ionModalDidDismiss)="closeModalThree()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Confirm Usage</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeModalThree()">Close</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <p>Confirm using space {{ spaceId }}?</p>
          <ion-button expand="block" (click)="confirmModalThree()">Confirm</ion-button>
        </ion-content>
      </ng-template>
    </ion-modal>


  </div>
</ion-content>


